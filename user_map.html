<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Sharing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 400px; margin-top: 10px; }
        ul.suggestions { list-style: none; padding: 0; max-width: 300px; background: #fff; border: 1px solid #ccc; position: absolute; z-index: 1000; }
        ul.suggestions li { padding: 8px; cursor: pointer; }
        ul.suggestions li:hover { background: #f0f0f0; }
        input { width: 300px; padding: 8px; margin: 5px; }
    </style>
</head>
<body>

    <input type="text" id="from" placeholder="Enter pickup location">
    <ul id="fromSuggestions" class="suggestions"></ul>

    <input type="text" id="to" placeholder="Enter destination">
    <ul id="toSuggestions" class="suggestions"></ul>

    <button id="searchBtn">Find Rides</button>
    <ul id="storedData"></ul>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, get, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDWwGMfCu2nrnzsjVUL-aLl4I3fQFNQ984",
            authDomain: "tcch-66288.firebaseapp.com",
            databaseURL: "https://tcch-66288-default-rtdb.firebaseio.com",
            projectId: "tcch-66288",
            storageBucket: "tcch-66288.appspot.com",
            messagingSenderId: "621738318792",
            appId: "1:621738318792:web:75ea3bb8ab4b238d28fefd",
            measurementId: "G-BL3WD7KSCV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // OpenRouteService API Key
        const ORS_API_KEY = "5b3ce3597851110001cf62486ece71d78e9541678f8539aafd9d3697";
        const map = L.map('map').setView([18.5204, 73.8567], 12); // Default: Pune

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let fromMarker, toMarker;

        async function fetchLocationSuggestions(query, elementId) {
            if (query.length < 3) return; // Avoid too many API calls

            const response = await fetch(
                `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${query}&size=5`
            );
            const data = await response.json();

            const suggestionsList = document.getElementById(elementId);
            suggestionsList.innerHTML = ""; // Clear previous suggestions

            if (data.features) {
                data.features.forEach(place => {
                    const li = document.createElement("li");
                    li.textContent = place.properties.label;
                    li.onclick = () => {
                        document.getElementById(elementId.replace("Suggestions", "")).value = place.properties.label;
                        suggestionsList.innerHTML = ""; // Clear after selection
                    };
                    suggestionsList.appendChild(li);
                });
            }
        }

        function reverseGeocode(lat, lon, inputId) {
            fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lat=${lat}&point.lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                if (data.features.length > 0) {
                    document.getElementById(inputId).value = data.features[0].properties.label;
                }
            });
        }

        document.getElementById("from").addEventListener("input", (e) => {
            fetchLocationSuggestions(e.target.value, "fromSuggestions");
        });

        document.getElementById("to").addEventListener("input", (e) => {
            fetchLocationSuggestions(e.target.value, "toSuggestions");
        });

        map.on('click', function(e) {
            if (!fromMarker) {
                fromMarker = L.marker(e.latlng).addTo(map);
                reverseGeocode(e.latlng.lat, e.latlng.lng, "from");
            } else if (!toMarker) {
                toMarker = L.marker(e.latlng).addTo(map);
                reverseGeocode(e.latlng.lat, e.latlng.lng, "to");
            }
        });

        document.getElementById("searchBtn").addEventListener("click", async function () {
            const from = document.querySelector("#from").value.trim().toLowerCase();
            const to = document.querySelector("#to").value.trim().toLowerCase();
            const storedDataList = document.querySelector("#storedData");
            storedDataList.innerHTML = "";

            // Fetch matching users from Firebase
            const usersRef = ref(database, "users");
            get(usersRef).then(snapshot => {
                let found = false;

                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const userId = childSnapshot.key;

                    if (user.from.toLowerCase() === from && user.to.toLowerCase() === to) {
                        found = true;
                        let img = user.gender.toLowerCase() === "male" ? "male2.png" : "female2.png";

                        const listItem = document.createElement("li");
                        listItem.dataset.userId = userId;
                        listItem.innerHTML = `
                            <div class="data">
                                <img src="images/${img}" alt="pfp" class="pfp"><br>
                                <strong>Name:</strong> ${user.name} <br>
                                <strong>Gender:</strong> ${user.gender} <br>
                                <strong>Car:</strong> ${user.car} <br>
                                <strong>From:</strong> ${user.from} â†’ <strong>To:</strong> ${user.to} <br>
                                <strong>Time:</strong> ${user.time} <br>
                                <strong>No of People:</strong> <span class="people-count">${user.peopleCount}</span>/5<br>
                            </div>
                            <button class="select-btn">Confirm</button>
                        `;

                        storedDataList.appendChild(listItem);

                        onValue(ref(database, `users/${userId}`), snapshot => {
                            if (snapshot.exists()) {
                                let userData = snapshot.val();
                                listItem.querySelector(".people-count").innerText = userData.peopleCount;
                            }
                        });
                    }
                });

                if (!found) {
                    storedDataList.innerHTML = '<li class="no-data">No matching rides found.</li>';
                }
            });
        });

        document.querySelector("#storedData").addEventListener("click", async (event) => {
            if (event.target.classList.contains("select-btn")) {
                const listItem = event.target.closest("li");
                const userId = listItem.dataset.userId;
                let peopleCountRef = ref(database, `users/${userId}/peopleCount`);

                get(peopleCountRef).then(snapshot => {
                    if (snapshot.exists()) {
                        let currentCount = snapshot.val();
                        if (currentCount < 5) {
                            update(ref(database, `users/${userId}`), { peopleCount: currentCount + 1 });
                            alert("You have confirmed the selection!");
                        } else {
                            alert("Ride is full!");
                        }
                    }
                });
            }
        });
    </script>

</body>
</html>
